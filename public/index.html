<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCO Member History Lookup</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 30px; margin-bottom: 20px; }
        h1 { color: #2d3748; margin-bottom: 10px; font-size: 2em; }
        .subtitle { color: #718096; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; color: #4a5568; font-weight: 600; margin-bottom: 8px; }
        input[type="text"], input[type="password"] { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; }
        input[type="text"]:focus, input[type="password"]:focus { outline: none; border-color: #667eea; }
        button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 28px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
        button:disabled { background: #cbd5e0; cursor: not-allowed; }
        .results { display: none; }
        .results.show { display: block; }
        .section-title { color: #2d3748; font-size: 1.5em; margin: 30px 0 15px 0; padding-bottom: 10px; border-bottom: 3px solid #667eea; }
        .info-row { display: flex; padding: 12px 0; border-bottom: 1px solid #e2e8f0; }
        .info-label { font-weight: 600; color: #4a5568; width: 150px; }
        .info-value { color: #2d3748; flex: 1; }
        .team-item, .group-item { background: #f7fafc; border-left: 4px solid #667eea; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .team-name, .group-name { font-size: 1.2em; font-weight: 600; color: #2d3748; margin-bottom: 8px; }
        .detail-row { color: #4a5568; padding: 4px 0; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600; margin-left: 10px; }
        .badge-active { background: #c6f6d5; color: #22543d; }
        .badge-past { background: #fed7d7; color: #742a2a; }
        .loading { text-align: center; padding: 40px; color: #667eea; font-size: 1.1em; }
        .error { background: #fed7d7; color: #742a2a; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .credentials-note { background: #bee3f8; border-left: 4px solid #3182ce; padding: 15px; margin: 20px 0; border-radius: 4px; font-size: 0.9em; color: #2c5282; }
        .btn-secondary { background: #e2e8f0; color: #2d3748; padding: 10px 20px; font-size: 14px; margin-left: 10px; }
        .input-row { display: flex; gap: 10px; align-items: flex-end; }
        .input-row .form-group { flex: 1; margin-bottom: 0; }
        .progress { color: #667eea; font-size: 0.9em; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card" id="credentialsCard">
            <h1>PCO Member History Lookup</h1>
            <p class="subtitle">View comprehensive history from Planning Center</p>
            <div class="form-group">
                <label for="appId">Application ID</label>
                <input type="text" id="appId" placeholder="Enter your PCO Application ID">
            </div>
            <div class="form-group">
                <label for="secret">Secret</label>
                <input type="password" id="secret" placeholder="Enter your PCO Secret">
            </div>
            <div class="credentials-note">
                <strong>How to get credentials:</strong><br>
                1. Go to <a href="https://api.planningcenteronline.com/oauth/applications" target="_blank">api.planningcenteronline.com/oauth/applications</a><br>
                2. Create a new Personal Access Token<br>
                3. Copy the Application ID and Secret here
            </div>
            <button onclick="saveCredentials()">Save Credentials</button>
        </div>
        <div class="card" id="lookupCard" style="display: none;">
            <h1>PCO Member History Lookup</h1>
            <p class="subtitle">Enter a Person ID to view their complete history</p>
            <div class="input-row">
                <div class="form-group">
                    <label for="personId">Person ID</label>
                    <input type="text" id="personId" placeholder="Enter Planning Center Person ID" onkeypress="if(event.key==='Enter') lookupPerson()">
                </div>
                <button onclick="lookupPerson()" id="lookupBtn">Lookup</button>
                <button class="btn-secondary" onclick="changeCredentials()">Change Credentials</button>
            </div>
            <div id="loading" class="loading" style="display: none;">
                üîç Looking up person data...<br>
                <div class="progress" id="progress"></div>
            </div>
            <div id="error" class="error" style="display: none;"></div>
            <div id="results" class="results"></div>
        </div>
    </div>
    <script>
        const API_URL = window.location.origin;
        let appId = '', secret = '';
        
        function saveCredentials() {
            appId = document.getElementById('appId').value.trim();
            secret = document.getElementById('secret').value.trim();
            if (!appId || !secret) { alert('Please enter both Application ID and Secret'); return; }
            document.getElementById('credentialsCard').style.display = 'none';
            document.getElementById('lookupCard').style.display = 'block';
        }
        
        function changeCredentials() {
            document.getElementById('credentialsCard').style.display = 'block';
            document.getElementById('lookupCard').style.display = 'none';
            document.getElementById('results').classList.remove('show');
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }
        
        function updateProgress(message) {
            document.getElementById('progress').textContent = message;
        }
        
        async function fetchWithProxy(url) {
            const response = await fetch(`${API_URL}/api/pco-proxy`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url, appId, secret })
            });
            if (!response.ok) throw new Error((await response.json()).error || 'Request failed');
            return response.json();
        }
        
        async function fetchAllPages(baseUrl) {
            let allData = [], url = baseUrl + (baseUrl.includes('?') ? '&' : '?') + 'per_page=100';
            while (url) {
                const data = await fetchWithProxy(url);
                allData = allData.concat(data.data || []);
                url = data.links?.next || null;
            }
            return allData;
        }
        
        async function lookupPerson() {
            const personId = document.getElementById('personId').value.trim();
            if (!personId) { alert('Please enter a Person ID'); return; }
            
            document.getElementById('lookupBtn').disabled = true;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('results').classList.remove('show');
            
            try {
                updateProgress('Fetching person data...');
                const personData = await fetchWithProxy(`https://api.planningcenteronline.com/people/v2/people/${personId}`);
                const personName = personData.data.attributes.name;
                const personCreated = personData.data.attributes.created_at;
                
                let html = `
                    <div class="section-title">üë§ PCO PEOPLE</div>
                    <div class="info-row"><div class="info-label">Name:</div><div class="info-value">${personName}</div></div>
                    <div class="info-row"><div class="info-label">Person ID:</div><div class="info-value">${personId}</div></div>
                    <div class="info-row"><div class="info-label">Created Date:</div><div class="info-value">${formatDate(personCreated)}</div></div>
                `;
                
                updateProgress('Checking Services...');
                try {
                    const servicesData = await fetchWithProxy(`https://api.planningcenteronline.com/services/v2/people/${personId}`);
                    html += `
                        <div class="section-title">üìã PCO SERVICES</div>
                        <div class="info-row"><div class="info-label">Add Date:</div><div class="info-value">${formatDate(servicesData.data.attributes.created_at)}</div></div>
                        <div class="info-row"><div class="info-label">Removal Date:</div><div class="info-value">${servicesData.data.attributes.archived_at ? formatDate(servicesData.data.attributes.archived_at) : 'Still Active'}</div></div>
                        <h3 style="margin-top: 20px; color: #4a5568;">Scheduling History</h3>
                    `;
                    
                    updateProgress('Fetching scheduling history...');
                    const planPeople = await fetchAllPages(`https://api.planningcenteronline.com/services/v2/people/${personId}/plan_people`);
                    
                    if (planPeople.length > 0) {
                        const teamHistory = {};
                        for (const assignment of planPeople) {
                            const teamId = assignment.relationships?.team?.data?.id;
                            if (!teamId) continue;
                            if (!teamHistory[teamId]) {
                                teamHistory[teamId] = { teamName: 'Loading...', serviceType: 'Loading...', positions: new Set(), count: 0, firstScheduled: null, lastScheduled: null };
                            }
                            const position = assignment.attributes.team_position_name || assignment.attributes.status || 'Scheduled';
                            teamHistory[teamId].positions.add(position);
                            teamHistory[teamId].count++;
                            const sortDate = assignment.attributes.sort_date || assignment.attributes.created_at;
                            if (sortDate) {
                                if (!teamHistory[teamId].firstScheduled || sortDate < teamHistory[teamId].firstScheduled) teamHistory[teamId].firstScheduled = sortDate;
                                if (!teamHistory[teamId].lastScheduled || sortDate > teamHistory[teamId].lastScheduled) teamHistory[teamId].lastScheduled = sortDate;
                            }
                        }
                        
                        updateProgress('Fetching team details...');
                        for (const teamId of Object.keys(teamHistory)) {
                            try {
                                const teamData = await fetchWithProxy(`https://api.planningcenteronline.com/services/v2/teams/${teamId}`);
                                teamHistory[teamId].teamName = teamData.data.attributes.name;
                                const serviceTypeId = teamData.data.relationships?.service_type?.data?.id;
                                if (serviceTypeId) {
                                    const stData = await fetchWithProxy(`https://api.planningcenteronline.com/services/v2/service_types/${serviceTypeId}`);
                                    teamHistory[teamId].serviceType = stData.data.attributes.name;
                                }
                            } catch (e) {}
                        }
                        
                        const sortedTeams = Object.entries(teamHistory).sort((a, b) => (b[1].lastScheduled || '').localeCompare(a[1].lastScheduled || ''));
                        for (const [teamId, info] of sortedTeams) {
                            html += `
                                <div class="team-item">
                                    <div class="team-name">${info.teamName}</div>
                                    <div class="detail-row"><strong>Service Type:</strong> ${info.serviceType}</div>
                                    <div class="detail-row"><strong>Position(s):</strong> ${Array.from(info.positions).join(', ')}</div>
                                    <div class="detail-row"><strong>Times Scheduled:</strong> ${info.count}</div>
                                    <div class="detail-row"><strong>First Scheduled:</strong> ${formatDate(info.firstScheduled)}</div>
                                    <div class="detail-row"><strong>Last Scheduled:</strong> ${formatDate(info.lastScheduled)}</div>
                                </div>
                            `;
                        }
                    } else {
                        html += '<p style="color: #718096; margin-top: 10px;">No scheduling history found</p>';
                    }
                } catch (e) {
                    html += '<div class="section-title">üìã PCO SERVICES</div><p style="color: #718096;">Person does not exist in Services</p>';
                }
                
                updateProgress('Checking Groups...');
                try {
                    await fetchWithProxy(`https://api.planningcenteronline.com/groups/v2/people/${personId}`);
                    html += '<div class="section-title">üë• PCO GROUPS</div>';
                    const memberships = await fetchAllPages(`https://api.planningcenteronline.com/groups/v2/people/${personId}/memberships`);
                    
                    if (memberships.length > 0) {
                        const groupsMap = {};
                        const groupIds = [...new Set(memberships.map(m => m.relationships?.group?.data?.id).filter(Boolean))];
                        for (const groupId of groupIds) {
                            try {
                                const groupData = await fetchWithProxy(`https://api.planningcenteronline.com/groups/v2/groups/${groupId}`);
                                groupsMap[groupId] = { name: groupData.data.attributes.name, archived_at: groupData.data.attributes.archived_at };
                            } catch (e) {}
                        }
                        
                        const active = [], removed = [];
                        for (const membership of memberships) {
                            const groupId = membership.relationships?.group?.data?.id;
                            const groupInfo = groupsMap[groupId] || { name: 'Unknown Group', archived_at: null };
                            const memData = { name: groupInfo.name, role: membership.attributes.role || 'Member', joined: membership.attributes.joined_at, removed: groupInfo.archived_at };
                            groupInfo.archived_at ? removed.push(memData) : active.push(memData);
                        }
                        
                        if (active.length > 0) {
                            html += '<h3 style="margin-top: 20px; color: #4a5568;">Current Groups</h3>';
                            for (const mem of active) {
                                html += `<div class="group-item"><div class="group-name">${mem.name} <span class="badge badge-active">Active</span></div><div class="detail-row"><strong>Role:</strong> ${mem.role}</div><div class="detail-row"><strong>Start Date:</strong> ${formatDate(mem.joined)}</div></div>`;
                            }
                        }
                        if (removed.length > 0) {
                            html += '<h3 style="margin-top: 20px; color: #4a5568;">Previous Groups</h3>';
                            for (const mem of removed) {
                                html += `<div class="group-item"><div class="group-name">${mem.name} <span class="badge badge-past">Removed</span></div><div class="detail-row"><strong>Role:</strong> ${mem.role}</div><div class="detail-row"><strong>Start Date:</strong> ${formatDate(mem.joined)}</div><div class="detail-row"><strong>Removal Date:</strong> ${formatDate(mem.removed)}</div></div>`;
                            }
                        }
                    } else {
                        html += '<p style="color: #718096; margin-top: 10px;">No group memberships found</p>';
                    }
                } catch (e) {
                    html += '<div class="section-title">üë• PCO GROUPS</div><p style="color: #718096;">Person does not exist in Groups</p>';
                }
                
                document.getElementById('results').innerHTML = html;
                document.getElementById('results').classList.add('show');
            } catch (error) {
                document.getElementById('error').textContent = 'Error: ' + error.message;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('lookupBtn').disabled = false;
            }
        }
    </script>
</body>
</html>
